# cloud-migration

Изменение организации для облака: https://yandex.cloud/ru/docs/resource-manager/operations/cloud/change-organization

Данный репозиторий содержит примеры скриптов для изменения организации для облака с сохранением биндингов.

## Пререквизиты

- `jq`
- `yc`
- Желательно иметь права администратора в обеих организациях, чтобы не переключать профиль `yc`.

## Процесс

Нужно настроить федерацию в новой организации, нужно использовать те же логины пользователей, так как в скриптах подразумевается, что логины совпадают в старой и новой федерациях.

Нужно клонировать данный репозиторий:
```
git clone git@github.com:knpsh/cloud-move.git
cd cloud-move
```

Нужно подготовить идентификаторы:
- `<cloud-id>` – он не изменится после изменения организации
- `<source-organization-id>` – исходная организация
- `<target-organization-id>` – целевая организация
- `<source-federation-id>` – исходная федерация (в исходной организации)
- `<target-federation-id>` – новая федерация в целевой организации

Скрипты нужно выполнять по порядку.

### 1. Получение биндингов

```
./1_dump_bindings_source/dump_bindings.sh <cloud-id>
```

В папке `bindings` сохранятся назначения прав для облака и вложенных каталогов. На случай, если нужно будет что-то исправить или восстановить обратно.

### 2. Получение групп и членства групп

```
./2_dump_groups_source/dump_groups.sh <source-organization-id>
```

В папке `groups` будет создан файл `groups.json` со списком групп организации и ее членами.

### 3. Получение списка федеративных пользователей

```
./3_dump_federated_users_source/dump_federated_users.sh <source-federation-id>
```

В папке `federatedusers` будут сохранены пользователи в файл `users.json`.

### 4. Создание пользователей в новой организации

```
./4_create_federated_users_target/create_users.sh <target-federation-id>
```

Пользователи из файла `federatedusers/users.json` будут созданы в новой организации, с привязкой к новой федерации.
После первого входа пользователя будут заполнены его атрибуты.

После создания пользователей в новой организации – нужно их сохранить, список потребуется далее:

```
./4_create_federated_users_target/dump_federated_users.sh <target-federation-id>
```

Будет создан файл `target-users.json` в папке `federatedusers`. Теперь у нас есть два списка пользователей с новыми и старыми идентификаторами, которые можно смэтчить по имени пользователя.

### 5. Создание групп в новой организации

```
./5_create_groups_target/create_groups.sh <target-organization-id>
```

Будут созданы новые группы, с именами из файла `groups/groups.json`.

Группы нужно наполнить пользователями:
```
./5_create_groups_target/fill_groups.sh <target-organization-id>
```

Так как федеративных пользователей мы создали ранее – мы можем наполнить ими группы.
Паспортные учетные записи также будут добавлены в группы (если они приглашены в новую организацию).
Сервисные учетные записи будут добавлены позднее.

Еще раз сохраним список групп с новыми идентификаторами:
```
./5_create_groups_target/dump_groups.sh <target-organization-id>
```

Будет создан файл `groups/target-groups.json`. Теперь есть два списка групп, с новыми и старыми идентификаторами, совпадающими по имени группы.

### 6. Удаление биндингов

Необходимо удалить биндинги на облаке и каталогах для федеративных учетных записей и групп.

Биндинги будут удалены для федеративных пользователей:
```
./6_delete_bindings_source/delete_bindings_federated.sh <cloud-id>
```

Биндинги будут удалены для групп:
```
./6_delete_bindings_source/delete_bindings_groups.sh <cloud-id>
```

Так как биндинги сохранены в файлах в каталоге `bindings` – мы можем точечно их удалять и можем откатить изменения.

Вернуть биндинги для федеративных пользователей:
```
./6_delete_bindings_source/revert_deletion_federated.sh <cloud-id>
```

Вернуть биндинги для групп:
```
./6_delete_bindings_source/delete_bindings_groups.sh <cloud-id>
```

> Удаление биндингов на облаке и каталогах – необходимый шаг, так как без этого не получится изменить организацию для облака. Очень важно убедиться, что биндинги можно удалить автоматизированно и что есть возможность откатить изменение обратно, в случае проблем.

Необходимо изменить организацию: https://yandex.cloud/ru/docs/resource-manager/operations/cloud/change-organization

> При попытке изменить организацию для облака, в случае проблем, будет выведена ошибка, в которой будут указаны проблемные учетные записи, которые ещё используются.

Если операция изменения организации прошла успешно – облако изменит свое расположение и окажется в новой организации.

### 7. Восстановить биндинги

Восстановление биндингов для федеративных пользователей:
```
./7_create_bindings_target/restore_bindings_federated.sh <cloud-id>
```

Восстановление биндингов для групп:
```
./7_create_bindings_target/restore_bindings_groups.sh <cloud-id>
```

Также нужно еще раз выполнить наполнение групп, чтобы добавить сервисные учетные записи (они были перенесены вместе с облаком и каталогами):
```
./5_create_groups_target/fill_groups.sh <target-organization-id>
```

